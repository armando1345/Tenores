<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tenores</title>
  <meta name="description" content="El curso que te convertirá en un excelente miembro de este equipo" />
  <link rel="icon" type="image/svg+xml" href="https://res.cloudinary.com/dcwx23x5o/image/upload/v1760049941/logo_tenores_oeotg5.svg" />
  <style>
    :root{--bg:#0a0a0a;--fg:#fff;--muted:#cfd6dc;--card:#111213;--border:#1b1d1f;--accent:#0ffc7e;--r-xl:26px;--r-lg:16px;--container:1080px;--lyrics-zoom:1}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font-family:Futura,'Futura PT','Avenir Next',Avenir,'Trebuchet MS',system-ui,-apple-system,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;line-height:1.4}
    a{color:inherit;text-decoration:none}
    [hidden]{display:none!important}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .container{max-width:var(--container);margin:0 auto;padding:28px 18px 56px}
    header{display:grid;place-items:center;gap:14px}
    .logo{width:104px;height:104px;border-radius:50%;overflow:hidden;display:grid;place-items:center;background:#0f0f0f;box-shadow:0 0 40px rgba(15,252,126,.4)}
    .logo img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    h1{margin:0;font-weight:900;letter-spacing:.1em;text-transform:uppercase;font-size:clamp(28px,2.5vw + 8px,46px)}
    .bar{width:112px;height:3px;background:var(--accent);border-radius:999px}
    .sub{color:#b8bec4;font-size:15px;text-align:center;max-width:620px}

    .search{position:sticky;top:8px;z-index:10;margin:12px 0}
    .search input{width:100%;padding:14px 16px 14px 44px;border-radius:14px;border:1px solid var(--border);background:#0f1112;color:#fff;font-weight:600;outline:none}
    .search .ico{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:20px;height:20px;color:#9aa3ad}
    .suggest{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:12px;color:#9aa3ad;background:#111314;border:1px solid var(--border);padding:6px 8px;border-radius:999px}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{background:linear-gradient(180deg,#121314,#0f1011);border:1px solid var(--border);border-radius:var(--r-xl);min-height:150px;display:grid;place-items:center;position:relative;overflow:hidden}
    .card::before{content:"";position:absolute;inset:0;opacity:.06;background:center/60% no-repeat url('https://res.cloudinary.com/dcwx23x5o/image/upload/v1760049941/logo_tenores_oeotg5.svg')}
    .badge{position:absolute;top:10px;left:10px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center;background:#0f1112;border:1px solid var(--border);color:#9aa3ad;font-size:12px;font-weight:900}
    .title{z-index:1;padding:10px 16px;border-radius:999px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.08);font-weight:800;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap;max-width:88%;overflow:hidden;text-overflow:ellipsis}
    .active{box-shadow:0 0 0 2px rgba(15,252,126,.35) inset}

    #home[hidden],#song[hidden]{display:none}
    .back{display:inline-flex;gap:.6ch;align-items:center;margin-bottom:14px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#0f1112}
    .song-title{margin:0 0 6px;font-size:clamp(22px,2.2vw + 6px,32px);font-weight:900}
    .song-meta{color:#b8bec4;font-size:14px;margin-bottom:14px}
    .cols{display:grid;gap:16px;grid-template-columns:1fr} @media(min-width:840px){.cols{grid-template-columns:1fr 1fr}}
    .pane{background:linear-gradient(180deg,#141516,#0f1011);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px}
    .pane h3{margin:0 0 10px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;color:#9aa3ad}

    .player{position:relative;display:flex;align-items:center;gap:10px;border:1px solid var(--border);background:#0f1112;border-radius:12px;padding:10px 12px}
    .p-btn{min-width:40px;height:40px;border-radius:999px;border:1px solid var(--border);background:#111314;color:#fff;display:grid;place-items:center}
    .p-time{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .p-cur,.p-dur{font-variant-numeric:tabular-nums;color:#cfd6dc;font-weight:700;font-size:12px}
    .pbar{position:relative;flex:1;height:8px;background:#1b1d1f;border-radius:999px;overflow:hidden;cursor:pointer}
    .fill{position:absolute;left:0;top:0;height:100%;width:0%;background:var(--accent)}
    .more{position:relative}
    .more-btn{min-width:40px;height:40px;border-radius:999px;border:1px solid var(--border);background:#111314;color:#fff;display:grid;place-items:center}
    .menu{position:absolute;right:0;bottom:48px;background:#0f1112;border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:8px;width:180px}
    .menu-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .m-btn{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#111314;color:#fff}
    .speed-label{font-weight:800;color:#cfd6dc}

    .lyrics-card{grid-column:1/-1}
    .lyrics-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
    .chip{border:1px solid var(--border);background:#0f1112;color:#fff;border-radius:999px;padding:6px 8px;display:inline-flex;align-items:center;gap:.35ch;line-height:1;font-weight:700;font-size:12px}
    .lyrics-surface{border:1px solid var(--border);background:#0f1011;border-radius:14px;padding:14px}
    .lyrics-wrap{max-width:64ch;margin:0 auto;position:relative}
    .lyrics{font-size:calc(16px * var(--lyrics-zoom));line-height:1.75;color:var(--muted)}
    .lyrics .stanza{margin:0 0 12px;padding-left:10px;border-left:2px solid rgba(15,252,126,.12)}
    .lyrics-wrap.is-collapsed{max-height:32rem;overflow:hidden}
    .lyrics-wrap.is-collapsed::after{content:"";position:absolute;left:0;right:0;bottom:0;height:84px;background:linear-gradient(180deg,rgba(10,10,10,0),rgba(10,10,10,1))}

    .mini{position:fixed;left:12px;right:12px;bottom:calc(12px + env(safe-area-inset-bottom));z-index:50;background:#0f1112;border:1px solid var(--border);border-radius:16px;display:flex;align-items:center;gap:12px;padding:10px 12px;transition:transform .25s ease,opacity .25s ease}
    .mini--hidden{transform:translateY(150%);opacity:.2;pointer-events:none}
    .mini-btn{width:40px;height:40px;border-radius:999px;border:1px solid var(--border);background:#111314;color:#fff;display:grid;place-items:center}
    .mini-meta{min-width:0}
    .mini-title{font-weight:800;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini-sub{font-size:12px;color:#b8bec4}
    .mini-bar{flex:1;height:8px;background:#1b1d1f;border-radius:999px;overflow:hidden;cursor:pointer;touch-action:none}
    .mini-prog{width:0%;height:100%;background:var(--accent)}
    @media(min-width:840px){.mini{left:24px;right:auto;width:420px}}
    .btn{display:inline-flex;align-items:center;gap:.5ch;padding:6px 10px;font-size:12px;border-radius:999px;border:1px solid var(--border);background:#0f1112;color:#fff}
    .btn svg{width:14px;height:14px}
    .btn[aria-disabled="true"]{opacity:.5;pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo"><img src="https://res.cloudinary.com/dcwx23x5o/image/upload/v1760049941/logo_tenores_oeotg5.svg" alt="Logo Tenores"></div>
      <h1>Tenores</h1>
      <div class="bar"></div>
      <p class="sub">El curso que te convertirá en un excelente miembro de este equipo</p>
    </header>

    <main>
      <section id="home" aria-labelledby="canciones-titulo">
        <h2 id="canciones-titulo" class="sr-only">Canciones del coro navideño</h2>
        <div class="search">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-3.5-3.5"/></svg>
          <input id="q" type="search" placeholder="Buscar canción…" autocomplete="off" aria-label="Buscar canción" />
          <span class="suggest" id="suggest" hidden></span>
        </div>
        <div id="grid" class="grid" aria-labelledby="canciones-titulo">
          <a class="card" href="#fum" data-song="fum"><span class="badge">01</span><span class="title">Fum Fum Fum</span></a>
          <a class="card" href="#campanas" data-song="campanas"><span class="badge">02</span><span class="title">Canto de las campanas</span></a>
          <a class="card" href="#adeste" data-song="adeste"><span class="badge">03</span><span class="title">Adeste Fideles</span></a>
          <a class="card" href="#dona" data-song="dona"><span class="badge">04</span><span class="title">Dona Nobis Pacem</span></a>
          <a class="card" href="#fuentecilla" data-song="fuentecilla"><span class="badge">05</span><span class="title">Fuentecilla que corres</span></a>
          <a class="card" href="#estrella" data-song="estrella"><span class="badge">06</span><span class="title">Estrella Errante</span></a>
          <a class="card" href="#paz" data-song="paz"><span class="badge">07</span><span class="title">Himno a la paz</span></a>
          <a class="card" href="#merry" data-song="merry"><span class="badge">08</span><span class="title">We wish you a merry christmas</span></a>
          <a class="card" href="#kling" data-song="kling"><span class="badge">09</span><span class="title">Kling Glöckchen</span></a>
          <a class="card" href="#tannenbaum" data-song="tannenbaum"><span class="badge">10</span><span class="title">O Tannenbaum</span></a>
        </div>
      </section>

      <section id="song" hidden>
        <a class="back" href="#">← Volver</a>
        <h2 class="song-title" id="song-title">Título</h2>
        <p class="song-meta" id="song-meta">Tenores • Curso oficial</p>
        <div class="cols">
          <article class="pane">
            <h3>Explicación</h3>
            <audio id="aud-explain" preload="none"></audio>
            <div id="ui-explain" class="player" role="group" aria-label="Controles de explicación"></div>
            <div style="margin-top:8px">
              <a id="dl-explain" class="btn" href="#" download>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3v12"/><path d="m7 11 5 5 5-5"/><path d="M5 21h14"/></svg>
                <span id="lbl-explain">Descargar</span>
              </a>
            </div>
          </article>
          <article class="pane">
            <h3>Canción</h3>
            <audio id="aud-track" preload="none"></audio>
            <div id="ui-track" class="player" role="group" aria-label="Controles de canción"></div>
            <div style="margin-top:8px">
              <a id="dl-track" class="btn" href="#" download>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3v12"/><path d="m7 11 5 5 5-5"/><path d="M5 21h14"/></svg>
                <span id="lbl-track">Descargar</span>
              </a>
            </div>
          </article>
          <article class="pane lyrics-card">
            <div class="lyrics-head"><h3>Letra</h3><div><button id="fontDown" class="chip" aria-label="Reducir tamaño">A−</button><button id="fontUp" class="chip" aria-label="Aumentar tamaño">A+</button></div></div>
            <div class="lyrics-surface"><div id="wrap" class="lyrics-wrap"><div id="lyrics" class="lyrics"><em>Letra no disponible aún.</em></div></div></div>
            <div style="display:flex;justify-content:center;margin-top:8px"><button id="toggleLyrics" class="chip" hidden>Ver más</button></div>
          </article>
        </div>
      </section>
    </main>
  </div>

  <div id="mini" class="mini" hidden>
    <button id="miniPlay" class="mini-btn" aria-label="Reproducir"></button>
    <div class="mini-meta"><div id="miniTitle" class="mini-title">—</div><div id="miniSub" class="mini-sub">—</div></div>
    <div id="miniBar" class="mini-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div id="miniProg" class="mini-prog"></div></div>
    <button id="miniLoop" class="mini-btn" aria-label="Activar repetición"></button>
    <button id="miniClose" class="mini-btn" aria-label="Detener y cerrar">✕</button>
  </div>

  <script>
    const SONGS={
      fum:{title:'Fum Fum Fum',explain:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760051384/fum_fum_fum_explicacion_hcsfzy.mp3',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760051700/fum_fum_fum_cancion_c7zzyg.wav',lyrics:`Veinticinco de diciembre\nFum, fum, fum\nVeinticinco de diciembre\nFum, fum, fum\nFum, fum, fum, fum, fum, fum fum\nCarita de rosa\nParece una flor hermosa\nFum, fum, fum\n\nSopla el viento por las calles\nFum, fum, fum\nY la virgen tiene frío\nFum, fum, fum\nFum, fum, fum, fum, fum, fum fum\nQuieres niño mío\nEn mi corazón nacer\nFum, fum, fum\n\nCierren todos ya sus puertas\nFum, fum, fum\nY hasta el cielo se durmió\nFum, fum, fum\nFum, fum, fum, fum, fum, fum fum\nTelas de oro y plata\nYo te haré un buen colchón\nFum, fum, fum`},
      adeste:{title:'Adeste Fideles',explain:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760100617/adeste_explicacion_g74foi.wav',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760051838/adeste_cancion_kefxux.wav'},
      dona:{title:'Dona Nobis Pacem',explain:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760101534/dona_nobis_pacem___explicacion_3_rmnjay.mp3',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760054240/dona_nobis_pacem___cancion_hsep4p.wav'},
      fuentecilla:{title:'Fuentecilla que corres',explain:'',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760998122/fuentecilla_que_corres_cancion__qhqna2.mp3'},
      campanas:{title:'Canto de las campanas',explain:'',track:'https://res.cloudinary.com/dul66qlpq/video/upload/v1760142195/canto_de_las_campanas_cancion_tq94nl.mp3'},
      estrella:{title:'Estrella Errante',explain:'',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760997189/estrella_errante_cancion_m6bcdm.mp3'},
      paz:{title:'Himno a la paz',explain:'',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760997237/himno_a_la_paz_cancion_avurel.mp3'},
      merry:{title:'We wish you a merry christmas',explain:'',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1760997255/we_wish_you_cancion_pgz1i2.mp3'},
      kling:{title:'Kling Glöckchen, klingelingeling',explain:'',track:'https://res.cloudinary.com/dul66qlpq/video/upload/v1761827592/kling_cancion_xawypb.mp3'},
      tannenbaum:{title:'O Tannenbaum',explain:'',track:'https://res.cloudinary.com/dcwx23x5o/video/upload/v1761968289/oh_thanenbaum_kkhmya.mp3'}
    };

    const $home=document.getElementById('home');
    const $song=document.getElementById('song');
    const $title=document.getElementById('song-title');
    const $meta=document.getElementById('song-meta');
    const $exp=document.getElementById('aud-explain');
    const $trk=document.getElementById('aud-track');
    const $dlExp=document.getElementById('dl-explain');
    const $dlTrk=document.getElementById('dl-track');
    const $lblExp=document.getElementById('lbl-explain');
    const $lblTrk=document.getElementById('lbl-track');
    const $lyrics=document.getElementById('lyrics');
    const $wrap=document.getElementById('wrap');
    const $toggle=document.getElementById('toggleLyrics');
    const $fontUp=document.getElementById('fontUp');
    const $fontDown=document.getElementById('fontDown');

    const $grid=document.getElementById('grid');
    const $q=document.getElementById('q');
    const $suggest=document.getElementById('suggest');

    const $mini=document.getElementById('mini');
    const $miniPlay=document.getElementById('miniPlay');
    const $miniLoop=document.getElementById('miniLoop');
    const $miniClose=document.getElementById('miniClose');
    const $miniTitle=document.getElementById('miniTitle');
    const $miniSub=document.getElementById('miniSub');
    const $miniBar=document.getElementById('miniBar');
    const $miniProg=document.getElementById('miniProg');

    let current=null, currentAudio=null, plainLyrics='';

    function iconPlay(){return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="8,5 19,12 8,19 8,5"></polygon></svg>'}
    function iconPause(){return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="9" y1="5" x2="9" y2="19"/><line x1="15" y1="5" x2="15" y2="19"/></svg>'}
    function iconLoop(){return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>'}
    function iconMore(){return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="5" cy="12" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/></svg>'}

    function setActive(id){document.querySelectorAll('[data-song]').forEach(a=>a.classList.toggle('active',a.getAttribute('data-song')===id))}
    function showHome(){ $home.hidden=false; $song.hidden=true; setActive(''); if(!currentAudio || currentAudio.paused || currentAudio.ended){ stopMini(); } document.title='Tenores' }

    function ext(url){try{const u=new URL(url), p=u.pathname, i=p.lastIndexOf('.');return i!==-1?p.slice(i+1).toUpperCase():'MP3'}catch{return 'MP3'}}
    function fileExt(url){try{const u=new URL(url), p=u.pathname, i=p.lastIndexOf('.');return i!==-1?p.slice(i):'.mp3'}catch{return '.mp3'}}
    function cleanName(s){return s.replace(/[^a-z0-9\- _.]/gi,'_')}

    async function download(url,name,btn,labelEl){try{btn&&btn.setAttribute('aria-disabled','true');if(labelEl)labelEl.textContent='Descargando…';const res=await fetch(url);const blob=await res.blob();const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;document.body.appendChild(a);a.click();URL.revokeObjectURL(a.href);a.remove()}catch{open(url,'_blank')}finally{btn&&btn.setAttribute('aria-disabled','false');if(labelEl)labelEl.textContent='Descargar'}}

    function formatLyrics(s){
      if(!s) return '<em>Letra no disponible aún.</em>';
      const safe=s.replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
      return safe.trim().split(/\n{2,}/).map(b=>`<p class="stanza">${b.replace(/\n/g,'<br>')}</p>`).join('');
    }
    function setLyrics(text){plainLyrics=text||'';$lyrics.innerHTML=formatLyrics(plainLyrics);requestAnimationFrame(()=>{const tall=$wrap.scrollHeight>520||(plainLyrics.length>700&&innerWidth<840);$wrap.classList.toggle('is-collapsed',tall);$toggle.hidden=!tall;$toggle.textContent=tall?'Ver más':'Ver menos'})}
    function getZoom(){const z=parseFloat(localStorage.getItem('lyricsZoom')||'1');return isNaN(z)?1:Math.min(1.6,Math.max(0.8,z))}
    function setZoom(z){document.documentElement.style.setProperty('--lyrics-zoom', z);localStorage.setItem('lyricsZoom', z)}

    $fontUp.addEventListener('click',()=>setZoom(Math.min(1.6, getZoom()+0.1)));
    $fontDown.addEventListener('click',()=>setZoom(Math.max(0.8, getZoom()-0.1)));
    $toggle.addEventListener('click',()=>{const c=$wrap.classList.toggle('is-collapsed');$toggle.textContent=c?'Ver más':'Ver menos'});

    const SPEEDS=[0.75,1,1.25,1.5,2];
    let gSpeedIdx=parseInt(localStorage.getItem('audSpeedIdx')||'1',10); if(isNaN(gSpeedIdx)) gSpeedIdx=1; gSpeedIdx=Math.max(0,Math.min(SPEEDS.length-1,gSpeedIdx));
    const players={ex:null,tr:null};
    function applySpeedAll(){ [$exp,$trk].forEach(a=>{ try{ a.playbackRate=SPEEDS[gSpeedIdx]; }catch{} }); if(currentAudio){ try{ currentAudio.playbackRate=SPEEDS[gSpeedIdx]; }catch{} } players.ex&&players.ex.setSpeedLabel&&players.ex.setSpeedLabel(SPEEDS[gSpeedIdx]); players.tr&&players.tr.setSpeedLabel&&players.tr.setSpeedLabel(SPEEDS[gSpeedIdx]); localStorage.setItem('audSpeedIdx', String(gSpeedIdx)); }

    function buildPlayer(audio,root){
      root.innerHTML=`<button class="p-btn play" aria-label="Reproducir">${iconPlay()}</button><div class="p-time"><span class="p-cur">0:00</span><div class="pbar"><div class="fill"></div></div><span class="p-dur">0:00</span></div><div class="more"><button class="more-btn" aria-label="Más opciones">${iconMore()}</button><div class="menu" hidden><div class="menu-row"><button class="m-btn dec" aria-label="Reducir velocidad">−</button><span class="speed-label">1×</span><button class="m-btn inc" aria-label="Aumentar velocidad">+</button></div></div></div>`;
      const play=root.querySelector('.play'), cur=root.querySelector('.p-cur'), dur=root.querySelector('.p-dur'), bar=root.querySelector('.pbar'), fill=root.querySelector('.fill');
      const more=root.querySelector('.more-btn'), menu=root.querySelector('.menu'), dec=menu.querySelector('.dec'), inc=menu.querySelector('.inc'), sLabel=menu.querySelector('.speed-label');
      audio.playbackRate=SPEEDS[gSpeedIdx]; sLabel.textContent=(SPEEDS[gSpeedIdx]+'×').replace('.00','');
      function fmt(t){if(!isFinite(t))return'0:00';t=t|0;const m=(t/60)|0,s=(t%60)|0;return m+':'+String(s).padStart(2,'0')}
      function sync(){cur.textContent=fmt(audio.currentTime);if(isFinite(audio.duration))dur.textContent=fmt(audio.duration);fill.style.width=(audio.duration?(audio.currentTime/audio.duration)*100:0)+'%';play.innerHTML=audio.paused?iconPlay():iconPause()}
      function seek(x){const r=bar.getBoundingClientRect();const pct=Math.min(1,Math.max(0,(x-r.left)/r.width));if(isFinite(audio.duration))audio.currentTime=pct*audio.duration;sync()}
      play.addEventListener('click',()=>{audio.paused?audio.play():audio.pause()});
      bar.addEventListener('mousedown',e=>seek(e.clientX));
      bar.addEventListener('touchstart',e=>{seek(e.touches[0].clientX)},{passive:true});
      more.addEventListener('click',()=>{menu.hidden=!menu.hidden});
      dec.addEventListener('click',()=>{gSpeedIdx=Math.max(0,gSpeedIdx-1);applySpeedAll()});
      inc.addEventListener('click',()=>{gSpeedIdx=Math.min(SPEEDS.length-1,gSpeedIdx+1);applySpeedAll()});
      document.addEventListener('click',e=>{if(!root.contains(e.target))menu.hidden=true});
      audio.addEventListener('timeupdate',sync); audio.addEventListener('play',sync); audio.addEventListener('pause',sync); audio.addEventListener('loadedmetadata',sync);
      sync();
      return {reset(){cur.textContent='0:00';dur.textContent='0:00';fill.style.width='0%';play.innerHTML=iconPlay()}, setDisabled(off){[play,bar,more,dec,inc].forEach(el=>el.disabled=off);root.style.opacity=off?.5:1}, setSpeedLabel(val){ sLabel.textContent=(val+'×').replace('.00',''); }};
    }

    function bindMini(audio,label){currentAudio=audio;$miniTitle.textContent=SONGS[current]?.title||'—';$miniSub.textContent=label;$miniPlay.innerHTML=audio.paused?iconPlay():iconPause();$miniLoop.innerHTML=iconLoop();$mini.hidden=false;syncMini()}
    function syncMini(){if(!currentAudio){$mini.hidden=true;return}const d=currentAudio.duration||0;const pct=d?(currentAudio.currentTime/d)*100:0;$miniProg.style.width=pct+'%';$miniPlay.innerHTML=currentAudio.paused?iconPlay():iconPause();$miniLoop.classList.toggle('active',currentAudio.loop)}
    function stopMini(){if(currentAudio){try{currentAudio.pause();currentAudio.currentTime=0}catch{}}$mini.hidden=true;currentAudio=null}

    $miniPlay.addEventListener('click',()=>{if(!currentAudio)return;currentAudio.paused?currentAudio.play():currentAudio.pause();syncMini()});
    $miniLoop.addEventListener('click',()=>{if(!currentAudio)return;currentAudio.loop=!currentAudio.loop;syncMini()});
    $miniClose.addEventListener('click',stopMini);
    $miniBar.addEventListener('click',e=>{if(!currentAudio||!currentAudio.duration)return;const r=$miniBar.getBoundingClientRect();currentAudio.currentTime=((e.clientX-r.left)/r.width)*currentAudio.duration});

    function renderSong(id){const s=SONGS[id]; if(!s){showHome();return} current=id; $title.textContent=s.title; $meta.textContent='Tenores • Curso oficial'; $exp.src=s.explain||''; $trk.src=s.track||''; const hasE=!!s.explain, hasT=!!s.track; $lblExp.textContent=hasE?`Descargar ${ext(s.explain)}`:'Descargar'; $lblTrk.textContent=hasT?`Descargar ${ext(s.track)}`:'Descargar'; players.ex.setDisabled(!hasE); players.tr.setDisabled(!hasT); players.ex.reset(); players.tr.reset(); setLyrics(s.lyrics||''); setActive(id); $home.hidden=true; $song.hidden=false; document.title='Tenores – '+s.title; scrollTo({top:0,behavior:'smooth'}) }

    function router(){const h=(location.hash||'').slice(1); if(!h) return showHome(); renderSong(h)}

    function normalize(s){return s.toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g,'')}
    const items=[...document.querySelectorAll('#grid [data-song]')].map(a=>({el:a,id:a.getAttribute('data-song'),t:normalize(a.querySelector('.title').textContent)}));
    function filter(q){const n=normalize(q), vis=[]; items.forEach(({el,t})=>{const m=t.includes(n); el.hidden=!m; if(m) vis.push(el)}); $suggest.hidden=!n; $suggest.textContent= n ? (vis.length? `${vis.length} resultado${vis.length>1?'s':''}` : 'Sin resultados') : ''; if(n && vis[0]) vis[0].scrollIntoView({block:'center'}) }
    $q.addEventListener('input',()=>filter($q.value));
    $q.addEventListener('focus',()=>{setTimeout(()=>{const first=items.find(x=>!x.el.hidden)?.el;if(first) first.scrollIntoView({block:'center'})},250)});
    $q.addEventListener('keydown',e=>{if(e.key==='Escape'){ $q.value=''; filter(''); $q.blur(); }});

    function setup(){
      players.ex=buildPlayer($exp,document.getElementById('ui-explain'));
      players.tr=buildPlayer($trk,document.getElementById('ui-track'));
      applySpeedAll();
      [$exp,$trk].forEach((a,i)=>{const label=i? 'Canción':'Explicación'; a.addEventListener('play',()=>{bindMini(a,label)}); a.addEventListener('pause',syncMini); a.addEventListener('timeupdate',syncMini); a.addEventListener('ended',stopMini)});
      if($dlExp) $dlExp.addEventListener('click',e=>{e.preventDefault(); if(!current) return; const s=SONGS[current]; if(!s.explain) return; download(s.explain, cleanName(`${s.title} - explicacion${fileExt(s.explain)}`), $dlExp, $lblExp)});
      if($dlTrk) $dlTrk.addEventListener('click',e=>{e.preventDefault(); if(!current) return; const s=SONGS[current]; if(!s.track) return; download(s.track, cleanName(`${s.title} - cancion${fileExt(s.track)}`), $dlTrk, $lblTrk)});
      window.addEventListener('hashchange',router);
      setZoom(getZoom()); router();

      console.assert(formatLyrics('a\n\nb').includes('<p') && formatLyrics('a\nb').includes('<br>'), 'formatLyrics falló');
      console.assert(formatLyrics('<>&"\'').includes('&lt;') && formatLyrics('<>&"\'').includes('&gt;'), 'escape falló');
      console.assert(normalize('ÁÉÍÓÚ').includes('aeiou'), 'normalize falló');
    }

    document.addEventListener('DOMContentLoaded',setup);
  </script>
</body>
</html>
